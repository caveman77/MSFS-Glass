/*!
	Copyright (c) 2011-2015, Pavel Shramov, Bruno Bergot - MIT licence
*/ L.KML=L.FeatureGroup.extend({initialize:function(e,t){this._kml=e,this._layers={},this._kmlOptions=t,e&&this.addKML(e,t)},addKML:function(e,t){var n=L.KML.parseKML(e,t);if(n&&n.length){for(var r=0;r<n.length;r++)this.fire("addlayer",{layer:n[r]}),this.addLayer(n[r]);this.latLngs=L.KML.getLatLngs(e),this.fire("loaded")}},latLngs:[]}),L.Util.extend(L.KML,{parseKML:function(e,t){var n=this.parseStyles(e,t);this.parseStyleMap(e,n);for(var r,a=e.getElementsByTagName("Folder"),o=[],l=0;l<a.length;l++)this._check_folder(a[l])&&(r=this.parseFolder(a[l],n))&&o.push(r);a=e.getElementsByTagName("Placemark");for(var i=0;i<a.length;i++)this._check_folder(a[i])&&(r=this.parsePlacemark(a[i],e,n))&&o.push(r);a=e.getElementsByTagName("GroundOverlay");for(var s=0;s<a.length;s++)(r=this.parseGroundOverlay(a[s]))&&o.push(r);return o},_check_folder:function(e,t){for(e=e.parentNode;e&&"Folder"!==e.tagName;)e=e.parentNode;return!e||e===t},parseStyles:function(e,t){for(var n={},r=e.getElementsByTagName("Style"),a=0,o=r.length;a<o;a++){var l=this.parseStyle(r[a],t);l&&(n["#"+l.id]=l)}return n},parseStyle:function(e,t){var n,r,a={},o={},l={},i={color:!0,width:!0,Icon:!0,href:!0,hotSpot:!0};function s(e){for(var t={},n=0;n<e.childNodes.length;n++){var r=e.childNodes[n],a=r.tagName;if(i[a]){if("hotSpot"===a)for(var o=0;o<r.attributes.length;o++)t[r.attributes[o].name]=r.attributes[o].nodeValue;else{var g=r.childNodes&&r.childNodes.length?r.childNodes[0].nodeValue:null;if(!g)continue;"color"===a?(t.opacity=parseInt(g.substring(0,2),16)/255,t.color="#"+g.substring(6,8)+g.substring(4,6)+g.substring(2,4)):"width"===a?t.weight=parseInt(g):"Icon"===a?(l=s(r)).href&&(t.href=l.href):"href"===a&&(t.href=g)}}}return t}if((n=e.getElementsByTagName("LineStyle"))&&n[0]&&(a=s(n[0])),(n=e.getElementsByTagName("PolyStyle"))&&n[0]&&(o=s(n[0])),o.color&&(a.fillColor=o.color),o.opacity&&(a.fillOpacity=o.opacity),(n=e.getElementsByTagName("IconStyle"))&&n[0]&&(l=s(n[0])),l.href){var g={iconUrl:l.href,shadowUrl:null,anchorRef:{x:l.x,y:l.y},anchorType:{x:l.xunits,y:l.yunits}};"object"==typeof t&&"object"==typeof t.iconOptions&&L.Util.extend(g,t.iconOptions),a.icon=new L.KMLIcon(g)}return(r=e.getAttribute("id"))&&a&&(a.id=r),a},parseStyleMap:function(e,t){for(var n=e.getElementsByTagName("StyleMap"),r=0;r<n.length;r++){var a,o,l,i=n[r];(l=i.getElementsByTagName("key"))&&l[0]&&(a=l[0].textContent),(l=i.getElementsByTagName("styleUrl"))&&l[0]&&(o=l[0].textContent),"normal"===a&&(t["#"+i.getAttribute("id")]=t[o])}},parseFolder:function(e,t){var n,r,a=[];n=e.getElementsByTagName("Folder");for(var o=0;o<n.length;o++)this._check_folder(n[o],e)&&(r=this.parseFolder(n[o],t))&&a.push(r);n=e.getElementsByTagName("Placemark");for(var l=0;l<n.length;l++)this._check_folder(n[l],e)&&(r=this.parsePlacemark(n[l],e,t))&&a.push(r);n=e.getElementsByTagName("GroundOverlay");for(var i=0;i<n.length;i++)this._check_folder(n[i],e)&&(r=this.parseGroundOverlay(n[i]))&&a.push(r);if(a.length)return r=1===a.length?a[0]:new L.FeatureGroup(a),(n=e.getElementsByTagName("name")).length&&n[0].childNodes.length&&(r.options.name=n[0].childNodes[0].nodeValue),r},parsePlacemark:function(e,t,n,r){var a,o,l,i,s,g,h=r||{};for(o=0,s=e.getElementsByTagName("styleUrl");o<s.length;o++){var c=s[o].childNodes[0].nodeValue;for(var d in n[c])h[d]=n[c][d]}if(g=e.getElementsByTagName("Style")[0]){var u=this.parseStyle(e);if(u)for(i in u)h[i]=u[i]}var f=["MultiGeometry","MultiTrack","gx:MultiTrack"];for(a in f)for(o=0,s=e.getElementsByTagName(f[a]);o<s.length;o++){var p=this.parsePlacemark(s[o],t,n,h);if(void 0!==p)return this.addPlacePopup(e,p),p}var y=[],m=["LineString","Polygon","Point","Track","gx:Track"];for(l in m){var $=m[l];for(o=0,s=e.getElementsByTagName($);o<s.length;o++){var N=this["parse"+$.replace(/gx:/,"")](s[o],t,h);N&&y.push(N)}}if(y.length){var p=y[0];return y.length>1&&(p=new L.FeatureGroup(y)),this.addPlacePopup(e,p),p}},addPlacePopup:function(e,t){var n,r,a,o,l="";for((n=e.getElementsByTagName("name")).length&&n[0].childNodes.length&&(o=n[0].childNodes[0].nodeValue),n=e.getElementsByTagName("description"),r=0;r<n.length;r++)for(a=0;a<n[r].childNodes.length;a++)l+=n[r].childNodes[a].nodeValue;o&&t.bindPopup("<h2>"+o+"</h2>"+l,{className:"kml-popup"})},parseCoords:function(e){var t=e.getElementsByTagName("coordinates");return this._read_coords(t[0])},parseLineString:function(e,t,n){var r=this.parseCoords(e);if(r.length)return new L.Polyline(r,n)},parseTrack:function(e,t,n){var r=t.getElementsByTagName("gx:coord");0===r.length&&(r=t.getElementsByTagName("coord"));for(var a=[],o=0;o<r.length;o++)a=a.concat(this._read_gxcoords(r[o]));if(a.length)return new L.Polyline(a,n)},parsePoint:function(e,t,n){var r=e.getElementsByTagName("coordinates");if(r.length){var a=r[0].childNodes[0].nodeValue.split(",");return new L.KMLMarker(new L.LatLng(a[1],a[0]),n)}},parsePolygon:function(e,t,n){var r,a,o,l=[],i=[];for(a=0,r=e.getElementsByTagName("outerBoundaryIs");a<r.length;a++)(o=this.parseCoords(r[a]))&&l.push(o);for(a=0,r=e.getElementsByTagName("innerBoundaryIs");a<r.length;a++)(o=this.parseCoords(r[a]))&&i.push(o);return l.length?(n.fillColor&&(n.fill=!0),1===l.length)?new L.Polygon(l.concat(i),n):new L.MultiPolygon(l,n):void 0},getLatLngs:function(e){for(var t=e.getElementsByTagName("coordinates"),n=[],r=0;r<t.length;r++)n=n.concat(this._read_coords(t[r]));return n},_read_coords:function(e){var t,n="",r=[];for(t=0;t<e.childNodes.length;t++)n+=e.childNodes[t].nodeValue;for(t=0,n=n.split(/[\s\n]+/);t<n.length;t++){var a=n[t].split(",");!(a.length<2)&&r.push(new L.LatLng(a[1],a[0]))}return r},_read_gxcoords:function(e){var t="",n=[];return t=e.firstChild.nodeValue.split(" "),n.push(new L.LatLng(t[1],t[0])),n},parseGroundOverlay:function(e){var t=e.getElementsByTagName("LatLonBox")[0],n=new L.LatLngBounds([t.getElementsByTagName("south")[0].childNodes[0].nodeValue,t.getElementsByTagName("west")[0].childNodes[0].nodeValue],[t.getElementsByTagName("north")[0].childNodes[0].nodeValue,t.getElementsByTagName("east")[0].childNodes[0].nodeValue]),r={Icon:!0,href:!0,color:!0},a={};if(a=function e(t){for(var n={},a={},o=0;o<t.childNodes.length;o++){var l=t.childNodes[o],i=l.tagName;if(r[i]){var s=l.childNodes[0].nodeValue;"Icon"===i?(a=e(l)).href&&(n.href=a.href):"href"===i?n.href=s:"color"===i&&(n.opacity=parseInt(s.substring(0,2),16)/255,n.color="#"+s.substring(6,8)+s.substring(4,6)+s.substring(2,4))}}return n}(e),void 0!==t.getElementsByTagName("rotation")[0]){var o=t.getElementsByTagName("rotation")[0].childNodes[0].nodeValue;a.rotation=parseFloat(o)}return new L.RotatedImageOverlay(a.href,n,{opacity:a.opacity,angle:a.rotation})}}),L.KMLIcon=L.Icon.extend({options:{iconSize:[32,32],iconAnchor:[16,16]},_setIconStyles:function(e,t){L.Icon.prototype._setIconStyles.apply(this,[e,t])},_createImg:function(e,t){return(t=t||document.createElement("img")).onload=this.applyCustomStyles.bind(this,t),t.src=e,t},applyCustomStyles:function(e){var t=this.options,n=t.iconSize[0],r=t.iconSize[1];this.options.popupAnchor=[0,-.83*r],"fraction"===t.anchorType.x&&(e.style.marginLeft=-t.anchorRef.x*n+"px"),"fraction"===t.anchorType.y&&(e.style.marginTop=-(1-t.anchorRef.y)*r+1+"px"),"pixels"===t.anchorType.x&&(e.style.marginLeft=-t.anchorRef.x+"px"),"pixels"===t.anchorType.y&&(e.style.marginTop=t.anchorRef.y-r+1+"px")}}),L.KMLMarker=L.Marker.extend({options:{icon:new L.KMLIcon.Default}}),L.RotatedImageOverlay=L.ImageOverlay.extend({options:{angle:0},_reset:function(){L.ImageOverlay.prototype._reset.call(this),this._rotate()},_animateZoom:function(e){L.ImageOverlay.prototype._animateZoom.call(this,e),this._rotate()},_rotate:function(){if(L.DomUtil.TRANSFORM)this._image.style[L.DomUtil.TRANSFORM]+=" rotate("+this.options.angle+"deg)";else if(L.Browser.ie){var e=this.options.angle*(Math.PI/180),t=Math.cos(e),n=Math.sin(e);this._image.style.filter+=" progid:DXImageTransform.Microsoft.Matrix(sizingMethod='auto expand', M11="+t+", M12="+-n+", M21="+n+", M22="+t+")"}},getBounds:function(){return this._bounds}});